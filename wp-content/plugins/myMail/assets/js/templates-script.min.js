jQuery(document).ready(function(g){var f=g("#mymail_iframe"),h=g("#_wpnonce").val(),b=f.data("base"),e=g("#templateeditor"),n=g("textarea.editor"),j=g(".uploadinfo"),a=g.browser.webkit?g("body"):g("html"),c;g("a.external").on("click",function(){window.open(this.href);return false});g("#mymail_templates").on("click",".edit",function(){var s=g(this),w=s.closest(".available-template"),t=g(".available-template"),v=g(".template-ajax-loading").css({display:"inline"}),o=s.attr("href"),q=s.data("slug");if(s.parent().hasClass("disabled")){return false}if(!s.parent().is(".nav-tab")){t.removeClass("edit");w.addClass("edit");var p=w.data("id");var r=Math.floor((g("#mymail_templates").outerWidth())/(w.width()+22));var u=Math.floor(p/r)*r+r-1;e.find("textarea").val("");e.find("h3").html(w.find("h3").html());e.slideDown();e.insertAfter(t.eq(u).length?t.eq(u):t.last());d(e.offset().top-50)}w.removeClass("loading");l(q,o);return false}).on("click",".nav-tab",function(){return false}).on("click",".remove-file",function(){var o=g(this);if(confirm(o.data("confirm"))){i("remove_template",{file:o.data("file")},function(p){if(p.success){o.parent().fadeOut();o.parent().prev().find("a.edit").click()}})}event.stopPropagation();return false}).on("click","a.cancel",function(){e.slideUp();g(".available-template").removeClass("edit");return false}).on("click","button.save, button.saveas",function(){var s=g(this),o=g(".template-ajax-loading"),r=c.getValue(),q=g("span.message"),p;if(s.is(".saveas")&&!(p=prompt(mymailL10n.enter_template_name+":",""))){return false}o.css({display:"inline"}),s.prop("disabled",true);i("set_template_html",{content:r,name:p,slug:g("#slug").val(),file:g("#file").val()},function(t){o.hide();s.prop("disabled",false);if(t.success){q.fadeIn(10).html(t.msg).delay(2000).fadeOut();if(t.newfile){l(g("#slug").val(),"mymail/"+t.newfile)}}else{alert(t.msg)}},function(t,v,u){o.hide();s.prop("disabled",false);alert(v+" "+t.status+": "+u+"\n\nCheck the JS console for more info!")});return false}).on("click",".thickbox-preview",function(){var r=g(this),q=r.parent().find("img").attr("title"),p=r.data("slug"),o=r.attr("href");g("#thickboxbox").find("iframe").attr("src",o);g(".thickbox-filelist").empty().hide();tb_show(q,"?&width=900&inlineId=thickboxbox&TB_inline",null);g("#TB_window").width(936).height(700).css("margin-left",-936/2).css("margin-top",-700/2);i("get_file_list",{slug:p},function(s){if(s.success){var t="";g.each(s.files,function(u,v){t+='<li><a href="'+s.base+"/"+u+'" class="thickbox-file"><img src="'+v.screenshot+'"><span>'+v.label+" ("+u+")</span></a></li>"});g(".thickbox-filelist").html(t).slideDown()}else{alert(s.msg)}},function(s,u,t){loader.hide();$this.prop("disabled",false);alert(u+" "+s.status+": "+t+"\n\nCheck the JS console for more info!")});return false}).on("click","a.activate",function(){var r=g(this),p="",q=r.data("license")||"",o=r.data("slug");g("#template-"+o).addClass("add-license").find(".license").val(q).focus().select();return false}).on("click","a.download",function(){g(this).prop("disabled",true)}).on("click","a.update",function(){if(confirm(mymailL10n.update_note)){g(this).closest(".available-template").addClass("loading");return true}return false}).on("click","a.deletion",function(){if(confirm(k(mymailL10n.confirm_delete,g(this).data("name")))){g(this).closest(".available-template").addClass("loading");return true}return false}).on("click","a.download, a.activatelink, .save-license",function(){g(this).closest(".available-template").addClass("loading")});g(document).on("click","a.thickbox-file",function(){g(".thickbox-iframe").attr("src",g(this).attr("href"));return false});var m=function(){var o=new plupload.Uploader(wpUploaderInit);o.bind("Init",function(p){var q=g("#plupload-upload-ui");if(p.features.dragdrop&&!g(document.body).hasClass("mobile")){q.addClass("drag-drop");g("#drag-drop-area").bind("dragover.wp-uploader",function(){q.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){q.removeClass("drag-over")})}else{q.removeClass("drag-drop");g("#drag-drop-area").unbind(".wp-uploader")}if(p.runtime=="html4"){g(".upload-flash-bypass").hide()}});o.init();o.bind("FilesAdded",function(p,q){setTimeout(function(){p.refresh();p.start()},1)});o.bind("BeforeUpload",function(p,q){});o.bind("UploadFile",function(p,q){});o.bind("UploadProgress",function(p,q){j.html(k(mymailL10n.uploading,q.percent+"%"))});o.bind("Error",function(p,q){j.html(q.message);p.refresh()});o.bind("FileUploaded",function(p,r,q){console.log(p,r,q);q=g.parseJSON(q.response);if(q.success){location.reload()}else{j.html(q.error)}console.log(q)});o.bind("UploadComplete",function(p,q){})};if(typeof(wpUploaderInit)=="object"){m()}function l(p,o){i("get_template_html",{slug:p,href:o},function(q){g(".template-ajax-loading").hide();g("#file").val(q.file);g("#slug").val(q.slug);n.val(q.html);if(!c){var s={name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]};c=CodeMirror.fromTextArea(n.get(0),{mode:s,tabMode:"indent",lineNumbers:true,autofocus:true})}else{c.setValue(q.html)}var r="";g.each(q.files,function(t,u){r+=' <span class="nav-tab '+(t==q.file?"nav-tab-active":"")+'"><a href="mymail/'+t+'" data-slug="'+p+'" class="edit">'+u.label+"</a>";if(t!="index.html"&&t!="notification.html"){r+='<a class="remove-file mymail-icon" data-file="'+p+"/"+t+'" data-confirm="'+k(mymailL10n.delete_template_file,u.label,u.name)+'"></a>'}r+="</span>"});e.find(".nav-tab-wrapper").html(r)})}function d(p,o){a.animate({scrollTop:p},o&&function(){o()})}function k(){var o=Array.prototype.slice.call(arguments),p=o.shift();while(o.length){p=p.replace("%s",o.shift())}return p}function i(q,p,r,o){if(g.isFunction(p)){if(g.isFunction(r)){o=r}r=p;p={}}g.ajax({type:"POST",url:ajaxurl,data:g.extend({action:"mymail_"+q,_wpnonce:h},p),success:function(t,u,s){r&&r.call(this,t,u,s)},error:function(s,u,t){if(u=="error"&&!t){return}if(console){console.error(g.trim(s.responseText))}o&&o.call(this,s,u,t)},dataType:"JSON"})}});